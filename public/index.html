<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Talos Editor</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/easymde.min.css">
    <script src="js/easymde.min.js"></script>
    <script src="js/mermaid.min.js"></script>
	<script src="js/sweetalert2.js"></script>
	<script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/js-yaml.min.js"></script>
    <script src="js/markdown-it.min.js"></script>
	<script src="js/markdown-it-emoji.min.js"></script>
	<script src='js/pdfmake.min.js'></script>
	<script src='js/vfs_fonts.min.js'></script>
	<script src='js/htmltopdfmake.js'></script>
    <script src="js/jszip.min.js"></script>
    <script src="js/ejs.min.js"></script>
    <script src="js/FileSaver.min.js"></script>
	<script src="js/d3.min.js"></script>
    <script src="js/html-docx.js"></script>
    <script src="js/jepub.min.js"></script>
    <script src="js/talos.js"></script>
</head>

<body>
    <textarea>---
title: Ejemplo De Librojuego Con Talos
author: Billy Fernández
output: html
---
# Ejemplo De Librojuego
Este es solo un ejemplo para dar a los nuevos usuarios una idea de por dónde empezar.

Las líneas en la parte superior de este archivo son necesarias para agregar algunos metadatos para el libro, como el título (title), el autor (author) o el formato de salida (output, Talos soporta html, docx, epub y pdf).

# Introducción
Las secciones con un encabezado como este (es decir, que inicien con mayúscula) no se verán afectadas por Talos.

# 1
Aquí es donde comienza la historia. Que el encabezado diga 1 significa que Talos lo mantendrá como está y no lo moverá. Desde aquí puedes pasar a la [segunda] o [tercera] sección. Los nombres entre corchetes se usan como enlaces. Talos cambiará los enlaces a los números correctos después de barajar todas las secciones, por lo que "segundo" y "tercero" podrían no ser 2 o 3 en absoluto.

# segunda
A un encabezado como este se le asignará un número aleatorio. Debe tener solo letras minúsculas. Puede usar guiones bajos, de lo contrario Talos entenderá que esta sección no es parte de la historia que desea barajar o numerar. Aquí hay otro enlace a la tercera sección: [tercera]. También puede ir a [alguna_otra_seccion].

# tercera
Solo otra sección de ejemplo. ¿Sabías que puede poner imágenes y tablas y muchas otras cosas útiles en los archivos de Talos? Esto es porque usa Markdown, un lenguaje de marcado de texto. No hay ejemplos de eso aquí, pero puede ser útil saberlo. La historia termina aquí ya que no hay enlaces que salgan de esta sección.

# 5
Otro encabezado que es un número. Esta sección no se mezclará con las demás. También tenga en cuenta que las secciones anteriores ("segunda" y "tercera") no se moverán después de esta, y las secciones siguientes no se pondrán antes. Es posible que muchos libros no necesiten tener números fijos como este, pero se puede usar para mantener las secciones agrupadas. Si agrega dos secciones más antes de esta, habrá un error, porque no hay espacio para cuatro secciones entre 1 y 5.

# alguna_otra_seccion
Esto es solo para continuar con el ejemplo anterior. La sección numerada posterior a [5], siempre debería tener el número 6 o superior. La historia termina en la sección [10].

# inalcanzable
No hay enlaces a esta sección, pero aún así aparecerá en el documento.

# 10
Aquí termina la historia. El librojuego debe terminar con el número más alto. Establecer esto en 10 aquí deja algunos márgenes si se agregan algunas secciones más antes.

# Epílogo
Por supuesto, algunas secciones que no pertenecen al librojuego como esta también pueden aparecer más adelante en el libro. Recuerde que los encabezados que inician con mayúsculas se ignoran.
</textarea>
    <div id="diagram"></div>
    <script>
	const easyMDE = new EasyMDE({
    		autosave: {
        		enabled: true,
        		uniqueId: "talos-editor",
        		delay: 1000,
        		submit_delay: 5000,
        		timeFormat: {
            			locale: 'es-ES',
            			format: {
                			year: 'numeric',
                			month: 'long',
                			day: '2-digit',
                			hour: '2-digit',
                			minute: '2-digit',
            			},
        		},
        		text: "Autoguardado: "
    		},
        	spellChecker: false,
			status: ["words", "lines"],
        	nativeSpellcheck: false,
        	//hideIcons: ["fullscreen", "bold","italic", "heading", "quote", "unordered-list","ordered-list","link","image"],
			toolbar: ["preview", "side-by-side", "|", "heading-1a","link", "bold", "italic", "unordered-list", "|", "upload-code", "download-code", "capture", "compile", "export", "|", "find", "zoom-out", "zoom-in", "undo", "redo", "|", "guide", "about"],
    		status: false
    		});
        easyMDE.toggleFullScreen();
		easyMDE.toggleSideBySide();
       easyMDE.codemirror.setOption('lineNumbers', true);
	   easyMDE.codemirror.setOption('styleActiveLine', true);
       mermaid.initialize({
		   securityLevel: 'loose',
		   theme: "neutral",
		   flowchart: {htmlLabels: true, useMaxWidth:false}
		});
       
		function jumpToLine(i) {
			let editor = easyMDE.codemirror
			editor.focus();
			editor.setCursor(i,0); 
    		var t = editor.charCoords({line: i, ch: 0}, "local").top; 
    		var middleHeight = editor.getScrollerElement().offsetHeight / 55; 
    		editor.scrollTo(null, t - middleHeight - 5);
		}


       var sourcemmd;
	   var copymmd="";
	   var lines;
	   let trans;
	   let copytrans;
	   var k=1.0;
	   var x=0.1;
	   var y=0.1;
	   var firstUp = true;



	   /*****************************************************/
	   var zoom; let data = [], width = 600, height = 400, numPoints = 100;


function initZoom() {
	if(firstUp){
		zoom = d3.zoom()
			.scaleExtent([1, 6])
			.on('zoom', handleZoom)
			d3.select('#graph-div')
			//.attr('transform', `translate(0, 0) scale(1)`)
			.call(zoom);
		firstUp = false;
	}else{
			zoom = d3.zoom()
				.scaleExtent([1, 6])
				.on('zoom', handleZoom)
			d3.select('#graph-div')
				.call(zoom)
				.call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(k));
	}
	
}

function handleZoom(e) {
	d3.select('svg g')
			.attr('transform', e.transform);
		//.attr('transform', `translate(${x}, ${y})scale(${k})`);
		//.attr('transform', e.transform);
		k = e.transform.k;
		x = e.transform.x;
		y = e.transform.y;
}
	   /*****************************************************/
        function cMDtoMMD (elpreview, htmlLabels){
        sourcemmd="graph TD\nclassDef sub fill:#fdc\n";
		let sourcefile=easyMDE.value();
		lines = sourcefile.split('\n');
		let heading = /^#\s([a-z_0-9]*)(\s|$)/gm;
		let link = /\[([^\[\]]+)\](?!\(|\:|{)/gm;
		let div = /^(\:{3,})\s([\w]*)\s{0,1}.*?$/m;
		let ignored = /^#\s[A-Z].*$/m;
		let enddiv = /^(\:{3,})\s*?[^a-z_0-9]*$/m;
		let currentH="";

		//Detectar tipos de secciones
		let regexLib = {
  			normal: /^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,
  			fixed: /^[0-9]+\s{0,1}(.*)$/m
		};
		let subgraph = {};
		lines.forEach(function(line,index){
			if(line.match(heading)){
				let matches = Array.from(line.matchAll(heading), function (m){
					currentH = m[1];
					if (subgraph.enabled){
						subgraph.nodes.push(currentH);
					}
					sourcemmd += currentH + "(" + currentH + ")\n";
					sourcemmd += "class " + currentH + " clickable\n"
					if (currentH.match(regexLib.normal)) {
						//sourcemmd += "class " + currentH + " normal\n"
						sourcemmd += "style " + currentH + " fill:#c7c7ff\n"
					} else if (currentH.match(regexLib.fixed)) {
						//sourcemmd += "class " + currentH + " fixed\n"
						sourcemmd += "style " + currentH + " fill:#f4a4a4\n"
					}
				});
			} else if (line.match(link)){
				let matches = Array.from(line.matchAll(link), function (m){
					sourcemmd += currentH + " --> " + m[1] + "\n";
				});	
			} else if (line.match(div)){
				let sub = line.match(div);
				subgraph.enabled = true;
				subgraph.name = sub[2];
				subgraph.nodes = [];
			} else if (line.match(enddiv) && subgraph.enabled){
				sourcemmd += "subgraph " + subgraph.name + "\n";
				for (node of subgraph.nodes){
					sourcemmd += node + "\n";
				}
				sourcemmd += "end \nclass " + subgraph.name + " sub\n";
				subgraph = {};
			}
		});
		if (mermaid.parse(sourcemmd) && sourcemmd != copymmd){
			mermaid.render("graph-div", sourcemmd, function(svg){
				elpreview.innerHTML=svg

  				/***********************************************************************/
				
					initZoom();

				/************************************************************************/

			})
				let clickNodes = document.getElementsByClassName("clickable")
				for (el of clickNodes) {
					el.lastChild.addEventListener('click', function(element){
						let head = "# " + element.srcElement.innerText;
 						let ln = lines.findIndex(element => element.includes(head))
						jumpToLine(ln)
					})
				}
			copymmd = sourcemmd
		}
	}
    </script>
</body>
</html>
