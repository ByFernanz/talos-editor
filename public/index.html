<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Talos Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bellefair&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../dist/easymde.min.css">
    <script src="../dist/easymde.min.js"></script>
    <script src="js/mermaid.min.js"></script>
	<script src="js/sweetalert2.js"></script>
	<script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/js-yaml.min.js"></script>
    <script src="js/markdown-it.min.js"></script>
    <script src="js/html2pdf.bundle.min.js"></script>
    <script src="js/jszip.min.js"></script>
    <script src="js/ejs.min.js"></script>
    <script src="js/FileSaver.min.js"></script>
    <script src="js/html-docx.js"></script>
    <script src="js/jepub.min.js"></script>
    <script src="js/talos.js"></script>
</head>

<body>
    <textarea>---
title: Pangamebook Gamebook Example
author: Pelle Nilsson
---

# Pangamebook Gamebook Example
This is just an example to give new users and idea where to start. See [Pandoc
Getting Started Article](https://pandoc.org/getting-started.html) and
[PangamebookREADME](README.md) for more information.

The lines at the very top of this file are needed to add some metadata
for the book. Otherwise there are ugly warnings when creating EPUB files
and possibly for other formats as well. Good to always include some
lines like that. Normally they are invisible and should not show
up in the output at all.

# Introduction
Sections with a header like this one will not be affected by the Pangamebook
filter, as described in the README.

# 1
This is where the story begins. That the header says just 1 like that means
that Pangamebook will keep it as it is, and not move it around.
From here you can move on to [second] or [third] section. If you read
this in the original Markdown file (example.md) you can tell that
the names of those sections are used as links (in square brackets).
Running Pandoc with the Pangamebook filter will change the links
to the correct numbers after shuffling all sections, so "second"
and "third" might end up not being 2 or 3 at all.

# second
This is the first header in the book that Pangamebook will see. Only
lower-case letters. It could have had some digits and underscores in
there as well, but anything else will make Pangamebook think it is
not part of the story you want to shuffle or number.
Here is another link to the third section: [third]. You
can also go on to [some_other_section].

# third
Just another example section. Did you know that you can put images and tables
and many other useful things in Pandoc Markdown files? There are no examples of
that here, but it can be useful to know. Guess the story ends here as there are
no links going out from this section.

# 5
Another header that is already a number. If you paid attention to
the description in the [README](README.md) you know that this
section will not be shuffled with other sections. Also notice
that the sections before ("second" and "third") will not be
moved to after this one, and the sections below will not move
to before. Many books might not need to ever have any fixed
numbers like this, but it can be used to keep sections grouped.
If you add two more sections before this there will be an
error, because there is not room for four sections between
1 and 5.

# some_other_section
This is just to continue the example with something after
section [5] that was fixed, and that this should always
have number 6 or higher. The story ends in section [10].

# unreached
There are not links to this section, but it should still
show up.

# 10
This ends the story. Most books have a best ending that has
the highest number in the book. Setting this to 10 here leaves
some margins if a few more sections are added before.

# Epilogue
Of course some non-gamebook sections like this can show up
later in the book as well. Remember Capitalized Headings
are ignored.
</textarea>
    <div id="diagram"></div>
    <script>
	const easyMDE = new EasyMDE({
    		autosave: {
        		enabled: true,
        		uniqueId: "talos-editor",
        		delay: 1000,
        		submit_delay: 5000,
        		timeFormat: {
            			locale: 'es-ES',
            			format: {
                			year: 'numeric',
                			month: 'long',
                			day: '2-digit',
                			hour: '2-digit',
                			minute: '2-digit',
            			},
        		},
        		text: "Autoguardado: "
    		},
        	spellChecker: false,
        	nativeSpellcheck: false,
        	//hideIcons: ["fullscreen", "bold","italic", "heading", "quote", "unordered-list","ordered-list","link","image"],
			toolbar: ["preview", "side-by-side", "|","upload-code", "download-code", "compile", "export", "|", "find", "undo", "redo", "|", "guide", "about"],
    		status: false
    		});
        easyMDE.toggleFullScreen();
		easyMDE.toggleSideBySide();
       easyMDE.codemirror.setOption('lineNumbers', true);
	   easyMDE.codemirror.setOption('styleActiveLine', true);
       mermaid.initialize({
		   securityLevel: 'loose',
		   theme: "neutral",
		   flowchart: {htmlLabels: true}
		});
       
		function jumpToLine(i) {
			let editor = easyMDE.codemirror
			editor.focus();
			editor.setCursor(i,0); 
    		var t = editor.charCoords({line: i, ch: 0}, "local").top; 
    		var middleHeight = editor.getScrollerElement().offsetHeight / 55; 
    		editor.scrollTo(null, t - middleHeight - 5);
		}


       var sourcemmd;
	   var copymmd="";
	   var lines;
        function cMDtoMMD (elpreview){
        sourcemmd="graph TD\n";
		let sourcefile=easyMDE.value();
		lines = sourcefile.split('\n');
		let heading = /^#\s([a-z_0-9]*)(\s|$)/gm;
		let link = /\[([^\[\]]+)\](?!\(|\:|{)/gm;
		let div = /^(\:{3,})\s([a-z][a-z_0-9]*)\s{0,1}.*?$/m;
		let enddiv = /^(\:{3,})\s*?[^a-z_0-9]*$/m;
		let currentH="";

		//Detectar tipos de secciones
		let regexLib = {
  			normal: /^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,
  			fixed: /^[0-9]+\s{0,1}(.*)$/m
		};
		lines.forEach(function(line,index){
			if(line.match(heading)){
				let matches = Array.from(line.matchAll(heading), function (m){
					currentH = m[1];
					sourcemmd += currentH + "(" + currentH + ")\n";
					sourcemmd += "class " + currentH + " clickable\n"
					if (currentH.match(regexLib.normal)) {
						//sourcemmd += "class " + currentH + " normal\n"
						sourcemmd += "style " + currentH + " fill:#c7c7ff\n"
					} else if (currentH.match(regexLib.fixed)) {
						//sourcemmd += "class " + currentH + " fixed\n"
						sourcemmd += "style " + currentH + " fill:#f4a4a4\n"
					}
				});
			} else if (line.match(link)){
				let matches = Array.from(line.matchAll(link), function (m){
					sourcemmd += currentH + " --> " + m[1] + "\n";
				});	
			} else if (line.match(div)){
				let sub = line.match(div);
				sourcemmd += "subgraph " + sub[2] + "\n";
			} else if (line.match(enddiv)){
				sourcemmd += "end \n";
			}
		});
		if (mermaid.parse(sourcemmd) && sourcemmd != copymmd){
			mermaid.render("graph-div", sourcemmd, function(svg){
				/*elpreview.innerHTML = `
				<div id="node-info">
					<div style="background: #c7c7ff;">No Fijas</div>
					<div style="background: #f4a4a4;">Fijas</div>
					<div style="background: #eee;">Inexistentes</div>
				</div>
				`;*/
				elpreview.innerHTML=svg
				let clickNodes = document.getElementsByClassName("clickable")
				for (el of clickNodes) {
					el.lastChild.addEventListener('click', function(element){
						let head = "# " + element.srcElement.innerText;
 						let ln = lines.findIndex(element => element.includes(head))
						jumpToLine(ln)
					})
				}
			})
			copymmd = sourcemmd
		}
	}
    </script>
</body>
</html>
